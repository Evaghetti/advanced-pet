<template>
  <g>
    <svg viewBox="0 0 83 75" width="83" height="75" x="48.05" y="64.94">
        <rect width="83" height="75" rx="3.01" ry="3.01" />
        <rect class="cls-1" x="3" y="3" width="77" height="69" />
        <g class="speak-animation">
            <g id="face-mouth-closed">
                <rect x="71.52" y="43.71" width="2.19" height="4.62" />
                <rect x="69.28" y="48.32" width="2.23" height="2.32" />
                <rect x="56.04" y="59.85" width="2.19" height="2.28" />
                <polygon points="73.7 29.78 73.7 27.52 71.52 27.52 71.52 32.04 73.7 32.04 73.7 43.71 75.87 43.71 75.87 29.78 73.7 29.78" />
                <rect x="20.47" y="71.28" width="2.19" height="0.75" />
                <rect x="58.27" y="69.04" width="4.42" height="2.29" />
                <rect x="62.68" y="71.34" width="2.24" height="0.75" />
                <rect x="22.66" y="69.04" width="4.46" height="2.24" />
                <rect x="64.91" y="50.64" width="4.38" height="2.27" />
                <polygon points="13.86 32.03 13.86 27.46 11.61 27.46 11.61 29.73 9.44 29.73 9.44 43.71 11.61 43.71 11.61 32.03 13.86 32.03" />
                <path d="M62.85,50.64h2.06V46H67.1v-2.3H64.91v-4.6H67.1v4.6h2.18v-7H67.1V34.37h2.18V27.52h2.24v-7H67.1v2.24H64.91V32H62.63V36.7H60.46v2.41H58.27V34.28h2.19V25.12h2.17V20.55h-40v4.6h2.27v9.13h2.18v4.83H24.93V36.87H22.66V32H20.5V22.79H18.28V20.55H13.86v6.91h2.21v6.82h2.21v2.59H16.07v6.84h2.21v-4.6h2.13v4.71H18.28V46h2.13v4.62H16V48.32H13.86V43.71H11.61v4.61H7.13v2.34H9.48v2.26h4.3v2.3h4.46v2.33h4.42v2.22h-11v2.42h6.63v2.18h4.42v2.38h4.45V69h2.21V66.75h2.21V69h2.18v3H51.56V69h2.29V66.75h2.21V69h2.21V64.37H56V62.13h-4.4v2.24H47.22v2.38H38.15V64.37H33.71V62.19H29.32V59.77H27.11V55.22H24.94V50.66H22.66v2.26H20.45V50.66h2.21V41.48h2.27V46h2.18V43.82h2.21V53H36V50.64H33.71V48.33H31.5V46h2.21v2.31h4.45v2.32h2.17V53h2.46v2.22H40.33V57.5H45V50.64h2.22V48.32h2.15v4.59H56V50.64H53.79V48.32H51.58V46h2.26v2.31H56V43.71h2.23V46h2.19V41.47h2.17v9.17H60.46v4.63H58.27v4.57h2.19v.54h2.39V55.27h2.06V52.91H62.85ZM51.53,34.28H33.74V22.79H51.53Z" />
                <polygon points="38.1 59.82 35.9 59.82 35.9 62.14 49.43 62.14 49.43 59.82 47.16 59.82 38.1 59.82" />
            </g>           
            <g id="face-mouth-opened">
                <rect x="56.04" y="59.85" width="2.19" height="2.28" />
                <rect x="20.47" y="71.28" width="2.19" height="0.75" />
                <rect x="22.66" y="69.04" width="4.46" height="2.24" />
                <rect x="58.27" y="69.04" width="4.42" height="2.29" />
                <rect x="62.68" y="71.34" width="2.24" height="0.75" />
                <polygon points="13.86 32.03 13.86 27.46 11.61 27.46 11.61 29.73 9.44 29.73 9.44 43.71 11.61 43.71 11.61 32.03 13.86 32.03" />
                <rect x="64.91" y="50.64" width="4.38" height="2.27" />
                <rect x="69.28" y="48.32" width="2.23" height="2.32" />
                <rect x="71.52" y="43.71" width="2.19" height="4.62" />
                <polygon points="73.7 29.78 73.7 27.52 71.52 27.52 71.52 32.04 73.7 32.04 73.7 43.71 75.87 43.71 75.87 29.78 73.7 29.78" />
                <path d="M62.85,50.64h2.06V46H67.1v-2.3H64.91v-4.6H67.1v4.6h2.18v-7H67.1V34.37h2.18V27.52h2.24v-7H67.1v2.24H64.91V32H62.63V36.7H60.46v2.41H58.27V34.28h2.19V25.12h2.17V20.55h-40v4.6h2.27v9.13h2.18v4.83H24.93V36.87H22.66V32H20.5V22.79H18.28V20.55H13.86v6.91h2.21v6.82h2.21v2.59H16.07v6.84h2.21v-4.6h2.13v4.71H18.28V46h2.13v4.62H16V48.32H13.86V43.71H11.61v4.61H7.13v2.34H9.48v2.26h4.3v2.3h4.46v2.33h4.42v2.22h-11v2.42h6.63v2.18h4.42v2.38h4.45V69h2.21V66.75h2.21V69H33.7v3H51.56V69h2.29V66.75h2.21V69h2.21V64.37H56V62.13h-4.4v2.24H47.22v2.38H38.15V64.37H33.7V62.19H29.32V59.77H27.11V55.22H24.94V50.66H22.66v2.26H20.45V50.66h2.21V41.48h2.27V46h2.18V43.82h2.21V53H36V50.64H33.71V48.33H31.5V46h2.21v2.31h4.45v2.32h2.17V53h2.46v2.27H45V50.64h2.22V48.32h2.15v4.59H56V50.64H53.79V48.32H51.58V46h2.26v2.31H56V43.71h2.23V46h2.19V41.47h2.17v9.17H60.46v4.63H58.27v4.57h2.19v.54h2.39V55.27h2.06V52.91H62.85ZM51.53,34.28H33.74V22.79H51.53Z" />
                <rect x="38.15" y="62.13" width="9.02" height="2.24" />
                <polygon points="49.43 57.5 47.16 57.5 38.1 57.5 35.9 57.5 35.9 62.13 38.1 62.13 38.1 59.85 47.16 59.85 47.16 62.13 49.43 62.13 49.43 57.5" />
            </g>                 
        </g>                         
        <rect class="cls-2" x="2" y="2" width="79" height="18.67" />
        <text class="greeting-text" transform="translate(5.75 18.33)">{{this.notification.message}}</text>
    </svg>   
  </g>
</template>

<script>
import { Howl } from 'howler';
import { TimelineLite } from "gsap";
import EventBus from '../../../../global/eventBus.js';
import { SceneNames, Events, NotificationTypes } from '../../../../global/constants';
import { mapState } from 'vuex';

export default {
  name: "Notification",
  data() {
    return {
      moveScene: false,
      virusSound: null,
      virusTimeout: null
    }
  },
  computed: {
    ...mapState({
      notification: state => state.session.notification
    })       
  },
  mounted() {
    this.registerListeners();

    if(this.notification.type === NotificationTypes.Virus) {
      if(this.$store.state.session.sound) {
        this.virusSound = new Howl({
          src: require("../../../../assets/sounds/virus-alert.mp3")
        });
        
        this.virusSound.play();
      }

      /*The virus will escape unless
      MegaMan is activated within one minute
      after receiving the Virus Detected prompt.*/
      this.virusTimeout = setTimeout(() => {
        this.onCancel();
      }, 60000);
    }

    var title1TimeLine = new TimelineLite({
      repeat: -1
    });

    title1TimeLine
      .set('.greeting-text', {x: 90})
      .to('.greeting-text',{ x: -114, duration: 3, ease: "none"});

    this.startSpeakingAnimation();
  },
  beforeDestroy() {
    this.unregisterListeners();
  },
  methods: {
    registerListeners() {
      EventBus.$on(Events.Confirmation, this.onConfirmation);
      EventBus.$on(Events.Cancel, this.onCancel);
    },
    unregisterListeners() {
      EventBus.$off(Events.Confirmation);
      EventBus.$off(Events.Cancel);
    },
    onConfirmation() {
      if(this.notification.type === NotificationTypes.Virus) {
        clearTimeout(this.virusTimeout);
        this.stopVirusSound();
        this.$store.commit('session/setCurrentScene', SceneNames.PlugIn);
      } else if(this.notification.type === NotificationTypes.Tournament) {
        this.$store.commit('session/setCurrentScene', SceneNames.Tournament);
      }
    },
    onCancel() {
      if(this.notification.type === NotificationTypes.Virus) {
        this.stopVirusSound();
        this.$store.commit('session/setNotification', null);
        this.$store.commit('session/setCurrentScene', SceneNames.StandBy);
      }
    },
    startSpeakingAnimation() {
      var timeLine = new TimelineLite({
        repeat: -1,
      });

      timeLine.to('#face-mouth-closed', {display: 'none', duration: 0.5,  ease: "none"});
      timeLine.to('#face-mouth-opened', {display: 'block', duration: 0.5,  ease: "none"});
      timeLine.play();
    },
    stopVirusSound() {
      if(this.virusSound != null) {
        this.virusSound.stop();
      }
    }
  }
}
</script>

<style scoped lang="scss">
#face-mouth-opened {
  display: none;
}

.cls-1,.greeting-text, .greeting-text-2{fill:#fff;}.cls-2{fill:#000501;}
.greeting-text, .greeting-text-2{font-size:13px;font-family:Advanced-PET-Font, Advanced PET Font;}
</style>